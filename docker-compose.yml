services:
  api:
    image: stumpisuter/augur-hakesch-api:dev
    build: ./src/api
    ports:
      - 8000:8000
    command: uvicorn main:app --host 0.0.0.0 --reload
    volumes:
      - ./src/api:/usr/src/app
    env_file: ".env"
    depends_on:
      - redis
    labels:
      # Enable Traefik for this specific "backend" service
      - traefik.enable=true
      # Define the port inside of the Docker service to use
      - traefik.http.services.app.loadbalancer.server.port=8000
      # Use the traefik-public network (declared below)
      - traefik.docker.network=traefik-public
      - traefik.http.routers.app-http.middlewares=https-redirect
    networks:
      # Use the public network created to be shared between Traefik and
      # any other service that needs to be publicly available with HTTPS
      - traefik-public

  view:
    image: stumpisuter/augur-hakesch-frontend:latest
    build: 
      context: ./src/frontend
      args:
        DATABASE_URL: ${DATABASE_URL}
    ports:
      - 3000:3000
    command: node build/index.js
    env_file: ".env"
    labels:
      # Enable Traefik for this specific "backend" service
      - traefik.enable=true
      # Define the port inside of the Docker service to use
      - traefik.http.services.app.loadbalancer.server.port=3000
      # Use the traefik-public network (declared below)
      - traefik.docker.network=traefik-public
      - traefik.http.routers.app-http.middlewares=https-redirect
    networks:
      - traefik-public

  worker:
    image: stumpisuter/augur-hakesch-api:dev
    build: ./src/api
    # solo pool: sequential task execution in main process, avoids fork() issues
    # with GDAL/numpy/scipy C extensions that are incompatible with prefork pool
    # restart: unless-stopped ensures the worker comes back after graceful shutdown
    # (the heavy raster task triggers a shutdown after completion to reclaim C memory)
    command: celery -A calculations.calculations.app worker --pool solo --loglevel=info --logfile=./logs/celery.log
    restart: unless-stopped
    volumes:
      - ./src/api:/usr/src/app
    env_file: ".env"
    environment:
      # Use jemalloc to prevent "double free or corruption" from GDAL/numpy C extensions
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libjemalloc.so.2
    depends_on:
      - api
      - redis
    deploy:
      resources:
        limits:
          memory: 16g
        reservations:
          memory: 8g
    networks:
      # Use the public network created to be shared between Traefik and
      # any other service that needs to be publicly available with HTTPS
      - traefik-public


  redis:
    image: redis:8.2.1
    networks:
      # Use the public network created to be shared between Traefik and
      # any other service that needs to be publicly available with HTTPS
      - traefik-public


  dashboard:
    build: ./src/api
    command: celery --broker=redis://redis:6379/0 flower --port=5555
    ports:
      - 5556:5555
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - api
      - redis
      - worker
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true
